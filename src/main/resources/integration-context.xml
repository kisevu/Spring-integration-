<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-jms="http://www.springframework.org/schema/integration/jms"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           https://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/integration
           https://www.springframework.org/schema/integration/spring-integration.xsd
           http://www.springframework.org/schema/integration/jms
           https://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd">

    <!-- Inbound Gateway checks queue for messages to process and pass them to service activator-->
    <int-jms:inbound-gateway
            connection-factory="connectionFactory"
            request-channel="jmsChannel"
            request-destination="queue"
            default-reply-destination="replyQueue"/>

    <int-jms:outbound-gateway
            connection-factory="connectionFactory"
            request-destination="queue"
            request-channel="outboundChannel"
            reply-destination="replyQueue"
            reply-channel="replyChannel"/>

    <bean id="connectionFactory" class="org.springframework.jms.connection.CachingConnectionFactory">
        <property name="targetConnectionFactory">
            <bean class="org.apache.activemq.ActiveMQConnectionFactory">
                <property name="brokerURL" value="tcp://localhost:61616"/>
            </bean>
        </property>
    </bean>

    <int:object-to-string-transformer
            input-channel="inboundChannel"
            output-channel="outboundChannel">
    </int:object-to-string-transformer>

    <int:gateway service-interface="com.ameda.kevin.integration_spring.PersonGateway"
                 default-request-channel="inboundChannel">
    </int:gateway>


    <int:channel id="jmsChannel"/>
    <int:channel id="inboundChannel"/>
    <int:channel id="outboundChannel"/>
    <int:channel id="replyChannel"/>

    <bean id="replyQueue" class="org.apache.activemq.command.ActiveMQQueue">
        <constructor-arg value="reply.queue"> </constructor-arg>
    </bean>
    <bean id="queue" class="org.apache.activemq.command.ActiveMQQueue">
        <constructor-arg value="sample.queue"> </constructor-arg>
    </bean>


    <bean id="printerService" class="com.ameda.kevin.integration_spring.PrintService"/>

    <int:service-activator ref="printerService" method="print"  input-channel="jmsChannel"/>
    <int:service-activator ref="printerService" method="printConsole"  input-channel="replyChannel"/>
</beans>

<!--
* Integration with JMS (Java Message Service) JMS Outbound Gateway
*******************************************************
* There are gateways provided in jms integrations.
* JMS Outbound Gateway is used to send a message from the spring jms application to a JMS queue.
* Once the message is placed upon a queue, another entity works the message and places a response on a replyQueue
from which the outbound gateway receives the message.
Once the Outbound Gateway receives the message it passes it to spring integration messaging system for further processing.
Process
*********************************************
* In main class the save method is invoked by the gateway.Person object is passed to inboundChannel as payload.
* It goes to the "object-to-string" transformer
* That message from transformer is passed to the Outbound Gateway
* The message is passed to the queue (sample.queue) on activeMQ server.
* Upon receiving the message,activeMQ server notifies the Inbound Gateway which receives the message and passes it to the
jmsChannel. JmsChannel drops the message with PrinterService bean which then invokes the print() message to replyQueue of the
Outbound Gateway(monitors the replyQueue). The message is delivered to the replyChannel which connected to another service
activator that invokes the printConsole() Which prints the message.
-->
